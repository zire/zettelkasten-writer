#!/bin/bash

# Zettelkasten Writer - Master Workflow Orchestration
# Your unified writing command center

set -e

# Get script directory
SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"

# Load all library functions
source "$SCRIPT_DIR/lib/menu.sh"
source "$SCRIPT_DIR/lib/frontmatter.sh"  
source "$SCRIPT_DIR/lib/editor.sh"
source "$SCRIPT_DIR/lib/publish.sh"
source "$SCRIPT_DIR/lib/session.sh"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
PURPLE='\033[0;35m'
BOLD='\033[1m'
DIM='\033[2m'
NC='\033[0m'

# Handle command line arguments for quick commands
case "${1:-}" in
    "save")
        # Interactive draft selection only
        show_header
        echo -e "${BLUE}💾 Select draft to save progress:${NC}"
        echo ""
        
        # Get and display drafts
        drafts=()
        while IFS= read -r line; do
            if [ -n "$line" ]; then
                drafts+=("$line")
            fi
        done < <(get_dsc_drafts)
        
        if [ ${#drafts[@]} -eq 0 ]; then
            echo -e "${YELLOW}📝 No drafts found${NC}"
            exit 1
        fi
        
        # Display drafts with numbers
        for i in "${!drafts[@]}"; do
            draft="${drafts[$i]}"
            IFS='|' read -r num title date word_count icon location_icon git_status_icon post_dir <<< "$draft"
            
            # Use red color for uncommitted drafts
            if [ -n "$git_status_icon" ]; then
                printf "${BLUE}%2d.${NC} ${location_icon} ${RED}${git_status_icon}${RED}${BOLD}%s${NC} ${DIM}(%s words, created %s)${NC}\n" \
                    $((i+1)) "$title" "$word_count" "$date"
            else
                printf "${BLUE}%2d.${NC} ${location_icon} ${git_status_icon}${BOLD}%s${NC} ${DIM}(%s words, created %s)${NC}\n" \
                    $((i+1)) "$title" "$word_count" "$date"
            fi
        done
        
        echo ""
        echo -ne "${BLUE}Enter draft number (or 'q' to quit):${NC} "
        read -r choice
        
        case "$choice" in
            q|quit|exit)
                echo -e "${YELLOW}Save cancelled${NC}"
                exit 0
                ;;
            *[!0-9]*)
                echo -e "${RED}❌ Invalid choice: $choice${NC}"
                exit 1
                ;;
            *)
                if [ "$choice" -ge 1 ] && [ "$choice" -le ${#drafts[@]} ]; then
                    selected_draft="${drafts[$((choice-1))]}"
                    IFS='|' read -r num title date word_count icon location_icon git_status_icon post_dir <<< "$selected_draft"
                    save_draft_progress "$title"
                else
                    echo -e "${RED}❌ Invalid draft number: $choice (valid range: 1-${#drafts[@]})${NC}"
                    exit 1
                fi
                ;;
        esac
        exit 0
        ;;
    "publish")
        if [ -n "$2" ]; then
            publish_post "$2"
        else
            echo -e "${RED}Usage: $0 publish \"Post Title\"${NC}"
        fi
        exit 0
        ;;
    "status")
        show_header
        echo -e "${BLUE}📊 All Drafts Status:${NC}"
        echo ""
        get_dsc_drafts
        exit 0
        ;;
    "help"|"--help"|"-h")
        show_header
        echo -e "${BLUE}🔧 Quick Commands:${NC}"
        echo -e "  ${GREEN}$0${NC}              - Interactive writing session (recommended)"
        echo -e "  ${GREEN}$0 save${NC}           - Save draft progress (numbered menu)"
        echo -e "  ${GREEN}$0 publish \"Title\"${NC} - Publish completed post"
        echo -e "  ${GREEN}$0 status${NC}         - Show all drafts"
        echo ""
        echo -e "${PURPLE}✨ Single-window workflow:${NC}"
        echo -e "  • Write in Cursor, save/publish from terminal session"
        echo -e "  • No need for multiple terminal windows"
        echo -e "  • Clear article info shows what you're working on"
        exit 0
        ;;
esac

# Main interactive loop
main_loop() {
    local current_site=""
    local site_name=""
    
    while true; do
        show_header
        
        if [ -z "$current_site" ]; then
            # Site selection menu
            show_site_menu
            read -r choice
            
            case "$choice" in
                1)
                    current_site="dsc"
                    site_name="Digital Sovereignty Chronicle"
                    ;;
                2)
                    current_site="sb"
                    site_name="The Sunday Blender"
                    ;;
                3)
                    current_site="hy"
                    site_name="Herbert Yang (Personal)"
                    ;;
                4)
                    echo -e "${YELLOW}⚠️  This site is coming soon!${NC}"
                    echo -ne "${BLUE}Press any key to continue...${NC}"
                    read -r
                    continue
                    ;;
                q|quit|exit)
                    echo -e "${GREEN}👋 Happy writing!${NC}"
                    exit 0
                    ;;
                *)
                    echo -e "${RED}Invalid choice${NC}"
                    echo -ne "${BLUE}Press any key to continue...${NC}"
                    read -r
                    continue
                    ;;
            esac
        else
            # Action menu for selected site
            show_action_menu "$site_name" "$current_site"
            read -r action
            
            case "$action" in
                n|new)
                    echo -e "${BLUE}✨ Creating new post...${NC}"
                    echo ""
                    
                    # Create new post with frontmatter wizard (site-specific)
                    if [[ "$current_site" == "dsc" ]]; then
                        create_dsc_frontmatter
                    elif [[ "$current_site" == "sb" ]]; then
                        create_sb_frontmatter
                    elif [[ "$current_site" == "hy" ]]; then
                        create_hy_frontmatter
                    else
                        echo -e "${RED}❌ Unsupported site: $current_site${NC}"
                        continue
                    fi
                    
                    if [ $? -eq 0 ]; then
                        post_file="$POST_FILE_RESULT"
                        echo ""
                        echo -ne "${PURPLE}Open in Cursor now? [Y/n]:${NC} "
                        read -r open_choice
                        
                        if [[ ! "$open_choice" =~ ^[Nn]$ ]]; then
                            open_in_cursor "$post_file"
                            show_writing_session_commands
                            show_current_article "$post_file"
                            echo ""
                            echo -ne "${BLUE}Press any key when done writing...${NC}"
                            read -r
                        fi
                    else
                        echo -e "${YELLOW}⚠️  Post creation cancelled. Returning to menu...${NC}"
                        echo -ne "${BLUE}Press any key to continue...${NC}"
                        read -r
                        continue
                    fi
                    ;;
                    
                e|edit)
                    echo -e "${BLUE}📝 Select draft to edit...${NC}"
                    echo ""
                    
                    if post_file=$(select_draft "edit" "$current_site"); then
                        # post_file now contains the direct path to the file
                        if [ -f "$post_file" ]; then
                            open_in_cursor "$post_file"
                            show_writing_session_commands
                            show_session_end_options "$post_file"
                            read -r session_choice
                            
                            case "$session_choice" in
                                s|save)
                                    local title=$(grep 'title:' "$post_file" | sed 's/title: "//' | sed 's/"//' | head -1)
                                    save_draft_progress "$title"
                                    echo ""
                                    echo -ne "${BLUE}Press any key to continue...${NC}"
                                    read -r
                                    end_writing_session
                                    ;;
                                p|publish)
                                    local title=$(grep 'title:' "$post_file" | sed 's/title: "//' | sed 's/"//' | head -1)
                                    publish_post "$title"
                                    echo ""
                                    echo -ne "${BLUE}Press any key to continue...${NC}"
                                    read -r
                                    end_writing_session
                                    ;;
                                c|continue)
                                    echo -e "${BLUE}💡 Keep writing! Theme remains active.${NC}"
                                    echo -ne "${BLUE}Press any key to continue...${NC}"
                                    read -r
                                    ;;
                                q|quit|*)
                                    end_writing_session
                                    ;;
                            esac
                        else
                            echo -e "${RED}❌ Could not find post file: $post_file${NC}"
                            echo -ne "${BLUE}Press any key to continue...${NC}"
                            read -r
                        fi
                    fi
                    ;;
                    
                p|publish)
                    echo -e "${BLUE}🚀 Select post to publish...${NC}"
                    echo ""
                    
                    if post_file=$(select_completed "$current_site"); then
                        # Extract title from the selected post file
                        local title=$(grep 'title:' "$post_file" | sed 's/title: "//' | sed 's/"//' | head -1)
                        publish_post "$title"
                        echo ""
                        echo -ne "${BLUE}Press any key to continue...${NC}"
                        read -r
                    fi
                    ;;
                    
                d|delete)
                    echo -e "${RED}🗑️  Select draft to delete...${NC}"
                    echo ""
                    
                    if post_dir=$(select_draft_for_deletion "$current_site"); then
                        delete_draft "$post_dir"
                        echo ""
                        echo -ne "${BLUE}Press any key to continue...${NC}"
                        read -r
                    fi
                    ;;
                    
                m|promote)
                    if [[ "$current_site" == "dsc" ]]; then
                        echo -e "${CYAN}⬆️  Select draft to promote...${NC}"
                        echo ""
                        
                        if draft_dir=$(select_draft_for_promotion "$current_site"); then
                            promote_draft "$draft_dir"
                            echo ""
                            echo -ne "${BLUE}Press any key to continue...${NC}"
                            read -r
                        fi
                    else
                        echo -e "${RED}❌ Draft promotion is only available for Digital Sovereignty Chronicle${NC}"
                        echo -ne "${BLUE}Press any key to continue...${NC}"
                        read -r
                    fi
                    ;;
                    
                b|back)
                    current_site=""
                    site_name=""
                    continue
                    ;;
                    
                q|quit|exit)
                    echo -e "${GREEN}👋 Happy writing!${NC}"
                    exit 0
                    ;;
                    
[a-z])
                    # Direct completed post selection by letter
                    echo -e "${BLUE}🚀 Publishing completed post $action...${NC}"
                    echo ""
                    
                    # Get the list of completed posts and select by letter
                    local completed=()
                    while IFS= read -r line; do
                        if [ -n "$line" ]; then
                            completed+=("$line")
                        fi
                    done < <(get_dsc_completed)
                    
                    # Convert letter to index (a=0, b=1, etc.)
                    local letter_idx=$(($(printf "%d" "'$action") - 97))
                    
                    if [ "$letter_idx" -ge 0 ] && [ "$letter_idx" -lt ${#completed[@]} ]; then
                        local selected_post="${completed[$letter_idx]}"
                        IFS='|' read -r num title date word_count icon post_dir <<< "$selected_post"
                        local post_file="$post_dir/index.md"
                        
                        if [ -f "$post_file" ]; then
                            local title_for_publish=$(grep 'title:' "$post_file" | sed 's/title: "//' | sed 's/"//' | head -1)
                            publish_post "$title_for_publish"
                            echo ""
                            echo -ne "${BLUE}Press any key to continue...${NC}"
                            read -r
                        else
                            echo -e "${RED}❌ Could not find post file: $post_file${NC}"
                            echo -ne "${BLUE}Press any key to continue...${NC}"
                            read -r
                        fi
                    else
                        echo -e "${RED}❌ Invalid completed post selection: $action${NC}"
                        echo -ne "${BLUE}Press any key to continue...${NC}"
                        read -r
                    fi
                    ;;
                    
                *)
                    # Check if it's a number for direct draft selection
                    if [[ "$action" =~ ^[0-9]+$ ]]; then
                        # Direct draft selection by number
                        echo -e "${BLUE}📝 Opening draft $action...${NC}"
                        echo ""
                        
                        # Get the list of drafts and select the nth one (site-specific)
                        local drafts=()
                        if [[ "$current_site" == "dsc" ]]; then
                            while IFS= read -r line; do
                                if [ -n "$line" ]; then
                                    drafts+=("$line")
                                fi
                            done < <(get_dsc_drafts)
                        elif [[ "$current_site" == "sb" ]]; then
                            while IFS= read -r line; do
                                if [ -n "$line" ]; then
                                    drafts+=("$line")
                                fi
                            done < <(get_sb_drafts)
                        fi
                        
                        if [ "$action" -le ${#drafts[@]} ] && [ "$action" -ge 1 ]; then
                            local selected_draft="${drafts[$((action-1))]}"
                            if [[ "$current_site" == "dsc" ]]; then
                                IFS='|' read -r num title date word_count icon location_icon git_status_icon post_dir <<< "$selected_draft"
                            else
                                IFS='|' read -r num title date word_count icon post_dir <<< "$selected_draft"
                            fi
                            local post_file="$post_dir/index.md"
                            
                            if [ -f "$post_file" ]; then
                                open_in_cursor "$post_file"
                                show_writing_session_commands
                                show_session_end_options "$post_file"
                                read -r session_choice
                                
                                case "$session_choice" in
                                    s|save)
                                        local title=$(grep 'title:' "$post_file" | sed 's/title: "//' | sed 's/"//' | head -1)
                                        save_draft_progress "$title"
                                        echo ""
                                        echo -ne "${BLUE}Press any key to continue...${NC}"
                                        read -r
                                        end_writing_session
                                        ;;
                                    p|publish)
                                        local title=$(grep 'title:' "$post_file" | sed 's/title: "//' | sed 's/"//' | head -1)
                                        publish_post "$title"
                                        echo ""
                                        echo -ne "${BLUE}Press any key to continue...${NC}"
                                        read -r
                                        end_writing_session
                                        ;;
                                    c|continue)
                                        echo -e "${BLUE}💡 Keep writing! Theme remains active.${NC}"
                                        echo -ne "${BLUE}Press any key to continue...${NC}"
                                        read -r
                                        ;;
                                    q|quit|*)
                                        end_writing_session
                                        ;;
                                esac
                            else
                                echo -e "${RED}❌ Could not find post file: $post_file${NC}"
                                echo -ne "${BLUE}Press any key to continue...${NC}"
                                read -r
                            fi
                        else
                            echo -e "${RED}❌ Invalid draft number: $action (valid range: 1-${#drafts[@]})${NC}"
                            echo -ne "${BLUE}Press any key to continue...${NC}"
                            read -r
                        fi
                    else
                        echo -e "${RED}Invalid choice${NC}"
                        echo -ne "${BLUE}Press any key to continue...${NC}"
                        read -r
                    fi
                    ;;
            esac
        fi
    done
}

# Start the interactive session
main_loop